<!DOCTYPE html>
<html>
<head>
    <link href="./style.css" rel="stylesheet" />
</head>
<body>
    <script src="peerjs.js"></script>
    <style>
        html{
            background-color: transparent;
        }
    </style>
    <script>
        let peer;
        async function init(userId) {
            async function getIceServers() {
                const response = await fetch(
                    "https://global.xirsys.net/_turn/MyFirstApp",
                    {
                        method: "PUT",
                        headers: {
                            Authorization:
                                "Basic " +
                                btoa("nhat:67e43036-a35e-11ef-8fc0-0242ac150002"),
                            "Content-Type": "application/json",
                        },
                    }
                );
                const iceServers = await response.json();
                return iceServers.v.iceServers; // Danh sách các ICE servers
            }

            // Sử dụng các ICE servers từ Xirsys trong cấu hình WebRTC
            getIceServers().then((iceServers) => {
                peer = new Peer(userId, {
                    host: "0.peerjs.com",
                    port: 443,
                    secure: true,
                    config: { iceServers: iceServers },
                });

                console.log(`Peer initialized with ID: ${userId}`);
                peer.on("open", () => {});
                listen();
            });
        }

        let localStream;

        // Hàm nhận cuộc gọi
        function listen() {
            peer.on("call", (call) => {
                navigator.getUserMedia(
                    { audio: true, video: false }, // Chỉ yêu cầu audio
                    (stream) => {
                        localStream = stream;
                        call.answer(stream); // Trả lời cuộc gọi với audio stream

                        call.on("stream", (remoteStream) => {
                            console.log("Voice call connected to remote user.");
                            // Bạn có thể bổ sung logic tại đây nếu cần hiển thị trạng thái
                        });
                    },
                    (err) => {
                        console.error("Failed to access microphone:", err);
                    }
                );
            });
        }

        // Hàm bắt đầu cuộc gọi
        function startCall(otherUserId) {
            navigator.getUserMedia(
                { audio: true, video: false }, // Chỉ yêu cầu audio
                (stream) => {
                    localStream = stream;

                    const call = peer.call(otherUserId, stream);
                    if (!call) {
                        console.error("Call failed to connect.");
                        return;
                    }

                    console.log("Voice call started.");
                    call.on("stream", (remoteStream) => {
                        console.log("Connected to remote user's voice stream.");
                        // Bạn có thể bổ sung logic tại đây nếu cần hiển thị trạng thái
                    });
                },
                (err) => {
                    console.error("Failed to access microphone:", err);
                }
            );
        }

        // Bật/tắt micro
        function toggleAudio(b) {
            if (localStream) {
                localStream.getAudioTracks()[0].enabled = b === "true";
            }
        }
    </script>
</body>
</html>