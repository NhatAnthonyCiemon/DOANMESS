<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerJS Group Voice Call</title>
    <link rel="stylesheet" href="./reset.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .voice__contain {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            grid-template-rows: repeat(1, 1fr);
            width: 100%;
            background-color: #f0f0f0;
            justify-content: center;
        }

        .voice__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .voice__avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
        }

        .voice__name {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>

<body>
<div class="voice__contain" id="voice-contain"></div>
<script src="./peerjs.js"></script>
<script>
    let peer;
    let localStream;
    let peerConnections = {};
    const voiceContain = document.getElementById("voice-contain");

    // Thiết lập PeerJS
    function init(userId) {
        async function getIceServers() {
            const response = await fetch(
                "https://global.xirsys.net/_turn/MyFirstApp",
                {
                    method: "PUT",
                    headers: {
                        Authorization:
                            "Basic " +
                            btoa("nhat:67e43036-a35e-11ef-8fc0-0242ac150002"),
                        "Content-Type": "application/json",
                    },
                }
            );
            const iceServers = await response.json();
            return iceServers.v.iceServers;
        }

        getIceServers().then((iceServers) => {
            peer = new Peer(userId, {
                host: "0.peerjs.com",
                port: 443,
                secure: true,
                config: {
                    iceServers: iceServers,
                },
            });

            peer.on("open", () => {
                console.log(`Peer opened with ID: ${peer.id}`);
            });

            listenForCalls();
        });
    }

    // Lắng nghe cuộc gọi đến
    function listenForCalls() {
        peer.on("call", (call) => {
            navigator.getUserMedia(
                { audio: true, video: false },
                (stream) => {
                    localStream = stream;
                    call.answer(stream);

                    // Lưu kết nối và xử lý stream của người gọi
                    peerConnections[call.peer] = call;

                    call.on("stream", (remoteStream) => {
                        addRemoteAudio(call.peer, remoteStream);
                    });
                }
            );
        });
    }

    // Thêm avatar và tên người gọi vào giao diện
    function addRemoteAudio(peerId, stream, avatarUrl = "", name = "Unknown") {
        let userContainer = document.getElementById(peerId);
        if (!userContainer) {
            userContainer = document.createElement("div");
            userContainer.id = peerId;
            userContainer.className = "voice__item";

            const avatar = document.createElement("img");
            avatar.src = avatarUrl;
            avatar.alt = name;
            avatar.className = "voice__avatar";

            const userName = document.createElement("div");
            userName.className = "voice__name";
            userName.textContent = name;

            userContainer.appendChild(avatar);
            userContainer.appendChild(userName);
            voiceContain.appendChild(userContainer);
        }

        const audio = document.createElement("audio");
        audio.autoplay = true;
        audio.srcObject = stream;
        userContainer.appendChild(audio);
    }

    // Gọi nhóm (tất cả thành viên trong danh sách)
    async function startGroupCall(memberId, avatarUrl = "", name = "Unknown") {
        navigator.getUserMedia(
            { audio: true, video: false },
            (stream) => {
                localStream = stream;
                if (memberId === peer.id) return; // Không gọi chính mình
                const call = peer.call(memberId, stream);

                // Lưu kết nối và xử lý stream của người gọi
                peerConnections[memberId] = call;

                call.on("stream", (remoteStream) => {
                    addRemoteAudio(memberId, remoteStream, avatarUrl, name);
                });
            }
        );
    }

    // Xử lý bật/tắt audio
    function toggleAudio(b) {
        if (b === "true") {
            localStream.getAudioTracks()[0].enabled = true;
        } else {
            localStream.getAudioTracks()[0].enabled = false;
        }
    }

    // Khởi tạo peer với userId (gọi hàm init với ID của bạn)
</script>
</body>

</html>
